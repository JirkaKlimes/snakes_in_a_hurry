from snakes_in_a_hurry.game import CUDASnakeGame
from tabulate import tabulate

if __name__ == "__main__":
    SIZES = [8, 16, 32, 64, 128, 256]
    NUM_GAMES = [1024, 4096, 25600, 262144, 1048576]

    mem_usage = []

    # Collect memory usage data for each grid size
    for size in SIZES:
        game = CUDASnakeGame(size, 1)
        data = game.game_state_host.__dict__.values()
        nbytes = sum(map(lambda arr: arr.nbytes, data))
        mem_usage.append(nbytes)

    # Construct the table with appropriate headers
    headers = ["Grid Size"] + [f"{s}x{s}" for s in SIZES]
    table = []

    # Fill the table rows with memory usage data for each game count
    for num in NUM_GAMES:
        row = [f"{num} games"] + [f"{num * b * 1e-6:.2f} MB" for b in mem_usage]
        table.append(row)

    # Print the table using tabulate with a fancy grid format and right alignment
    print(
        tabulate(
            table,
            headers=headers,
            tablefmt="fancy_grid",
            numalign="right",
            stralign="right",
        )
    )
    # Version: original
    # ╒═══════════════╤═══════════╤════════════╤════════════╤═════════════╤═════════════╤══════════════╕
    # │     Grid Size │       8x8 │      16x16 │      32x32 │       64x64 │     128x128 │      256x256 │
    # ╞═══════════════╪═══════════╪════════════╪════════════╪═════════════╪═════════════╪══════════════╡
    # │    1024 games │   0.28 MB │    1.07 MB │    4.21 MB │    16.80 MB │    67.13 MB │    268.46 MB │
    # ├───────────────┼───────────┼────────────┼────────────┼─────────────┼─────────────┼──────────────┤
    # │    4096 games │   1.13 MB │    4.28 MB │   16.86 MB │    67.19 MB │   268.52 MB │   1073.82 MB │
    # ├───────────────┼───────────┼────────────┼────────────┼─────────────┼─────────────┼──────────────┤
    # │   25600 games │   7.07 MB │   26.73 MB │  105.37 MB │   419.94 MB │  1678.23 MB │   6711.40 MB │
    # ├───────────────┼───────────┼────────────┼────────────┼─────────────┼─────────────┼──────────────┤
    # │  262144 games │  72.35 MB │  273.68 MB │ 1078.98 MB │  4300.21 MB │ 17185.11 MB │  68724.72 MB │
    # ├───────────────┼───────────┼────────────┼────────────┼─────────────┼─────────────┼──────────────┤
    # │ 1048576 games │ 289.41 MB │ 1094.71 MB │ 4315.94 MB │ 17200.84 MB │ 68740.45 MB │ 274898.88 MB │
    # ╘═══════════════╧═══════════╧════════════╧════════════╧═════════════╧═════════════╧══════════════╛

    # Version: bitboards using uint16 + shiffting
    # ╒═══════════════╤═══════════╤═══════════╤════════════╤════════════╤═════════════╤══════════════╕
    # │     Grid Size │       8x8 │     16x16 │      32x32 │      64x64 │     128x128 │      256x256 │
    # ╞═══════════════╪═══════════╪═══════════╪════════════╪════════════╪═════════════╪══════════════╡
    # │    1024 games │   0.17 MB │   0.61 MB │    2.38 MB │    9.46 MB │    37.77 MB │    151.02 MB │
    # ├───────────────┼───────────┼───────────┼────────────┼────────────┼─────────────┼──────────────┤
    # │    4096 games │   0.67 MB │   2.44 MB │    9.52 MB │   37.83 MB │   151.08 MB │    604.06 MB │
    # ├───────────────┼───────────┼───────────┼────────────┼────────────┼─────────────┼──────────────┤
    # │   25600 games │   4.20 MB │  15.26 MB │   59.49 MB │  236.44 MB │   944.23 MB │   3775.39 MB │
    # ├───────────────┼───────────┼───────────┼────────────┼────────────┼─────────────┼──────────────┤
    # │  262144 games │  42.99 MB │ 156.24 MB │  609.22 MB │ 2421.16 MB │  9668.92 MB │  38659.95 MB │
    # ├───────────────┼───────────┼───────────┼────────────┼────────────┼─────────────┼──────────────┤
    # │ 1048576 games │ 171.97 MB │ 624.95 MB │ 2436.89 MB │ 9684.65 MB │ 38675.68 MB │ 154639.79 MB │
    # ╘═══════════════╧═══════════╧═══════════╧════════════╧════════════╧═════════════╧══════════════╛

    # Version: bitboards and body_dir using uint16 + shiffting
    # ╒═══════════════╤══════════╤═══════════╤═══════════╤════════════╤═════════════╤═════════════╕
    # │     Grid Size │      8x8 │     16x16 │     32x32 │      64x64 │     128x128 │     256x256 │
    # ╞═══════════════╪══════════╪═══════════╪═══════════╪════════════╪═════════════╪═════════════╡
    # │    1024 games │  0.07 MB │   0.22 MB │   0.81 MB │    3.17 MB │    12.60 MB │    50.35 MB │
    # ├───────────────┼──────────┼───────────┼───────────┼────────────┼─────────────┼─────────────┤
    # │    4096 games │  0.28 MB │   0.87 MB │   3.23 MB │   12.66 MB │    50.41 MB │   201.41 MB │
    # ├───────────────┼──────────┼───────────┼───────────┼────────────┼─────────────┼─────────────┤
    # │   25600 games │  1.74 MB │   5.43 MB │  20.17 MB │   79.16 MB │   315.08 MB │  1258.80 MB │
    # ├───────────────┼──────────┼───────────┼───────────┼────────────┼─────────────┼─────────────┤
    # │  262144 games │ 17.83 MB │  55.57 MB │ 206.57 MB │  810.55 MB │  3226.47 MB │ 12890.14 MB │
    # ├───────────────┼──────────┼───────────┼───────────┼────────────┼─────────────┼─────────────┤
    # │ 1048576 games │ 71.30 MB │ 222.30 MB │ 826.28 MB │ 3242.20 MB │ 12905.87 MB │ 51560.58 MB │
    # ╘═══════════════╧══════════╧═══════════╧═══════════╧════════════╧═════════════╧═════════════╛
